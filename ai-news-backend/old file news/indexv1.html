<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI News Reader Login</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      padding: 40px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    .card {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 350px;
      margin-bottom: 20px;
    }
    h1, h2 {
      text-align: center;
      color: #333;
    }
    input, select {
      margin: 10px 0;
      padding: 10px;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }
    button {
      padding: 10px;
      width: 100%;
      border: none;
      border-radius: 8px;
      background: #4a90e2;
      color: white;
      font-size: 16px;
      cursor: pointer;
      margin-top: 12px;
    }
    button:hover {
      background: #357abd;
    }
    .hidden { display: none; }
    #newsContainer {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .news-card {
      border: 1px solid #ddd;
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
      transition: transform 0.2s;
    }
    .news-card:hover { transform: translateY(-5px); }
    .news-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }
    .news-card .content {
      padding: 12px;
    }
    .news-card h4 {
      margin: 0 0 8px;
      font-size: 16px;
    }
    .news-card p {
      font-size: 13px;
      color: #555;
    }
  </style>
</head>
<body>
  <div class="card" id="login">
    <h1>üîê AI News Reader</h1>
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Enter email" />
    <button onclick="sendOTP()">Send OTP</button>
  </div>

  <div class="card hidden" id="otpSection">
    <h2>Enter OTP</h2>
    <input type="text" id="otp" placeholder="Enter OTP" />
    <button onclick="verifyOTP()">Verify OTP</button>
  </div>

  <div class="card hidden" id="profileSection">
    <h2>Setup Profile</h2>
    <input type="text" id="name" placeholder="Full Name" />
    
    <select id="profession">
      <option value="">Select Profession</option>
      <option>Student</option>
      <option>Engineer</option>
      <option>Doctor</option>
      <option>Teacher</option>
      <option>Entrepreneur</option>
      <option>Other</option>
    </select>

    <select id="gender">
      <option value="">Select Gender</option>
      <option>Male</option>
      <option>Female</option>
      <option>Other</option>
    </select>

    <input type="number" id="age" placeholder="Age" min="10" max="100" />

    <label>Choose Categories:</label>
    <select id="preferences" multiple>
      <option value="business">Business</option>
      <option value="entertainment">Entertainment</option>
      <option value="general">General</option>
      <option value="health">Health</option>
      <option value="science">Science</option>
      <option value="sports">Sports</option>
      <option value="technology">Technology</option>
    </select>
    <button onclick="saveProfile()">Save Profile</button>
  </div>

  <div class="card hidden" id="newsSection">
    <h2>Your Personalized News</h2>
    <div id="newsContainer"></div>
  </div>

  <script>
    const API_URL = "http://localhost:5000";
    const SUPABASE_URL = "https://fppmdeuzhoeytcszmssn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwcG1kZXV6aG9leXRjc3ptc3NuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NDE4NTYsImV4cCI6MjA3NDAxNzg1Nn0.5vNgnWKDX8IjEaf0jfVoPw-qsQSuXvo7j2fyKLfSdtw";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function sendOTP() {
      const email = document.getElementById("email").value;
      await fetch(`${API_URL}/login`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      });
      document.getElementById("otpSection").classList.remove("hidden");
    }

    async function verifyOTP() {
      const otp = document.getElementById("otp").value;
      const res = await fetch(`${API_URL}/verify-otp`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ otp })
      });
      const data = await res.json();
      if (data.success) {
        document.getElementById("profileSection").classList.remove("hidden");
      } else {
        alert("Invalid OTP!");
      }
    }

    async function saveProfile() {
      const name = document.getElementById("name").value;
      const profession = document.getElementById("profession").value;
      const gender = document.getElementById("gender").value;
      const age = document.getElementById("age").value;
      const preferences = Array.from(document.getElementById("preferences").selectedOptions).map(o => o.value);

      // Save to Supabase
      const { error } = await supabase.from("profiles").insert([
        { name, profession, gender, age, preferences }
      ]);
      if (error) console.error(error);

      // Fetch personalized news
      const newsRes = await fetch(`${API_URL}/news`);
      const newsData = await newsRes.json();

      document.getElementById("newsSection").classList.remove("hidden");
      const container = document.getElementById("newsContainer");
      container.innerHTML = "";

      newsData.news.forEach(section => {
        section.articles.forEach(a => {
          container.innerHTML += `
            <div class="news-card">
              <img src="${a.urlToImage || 'https://via.placeholder.com/300'}" />
              <div class="content">
                <h4><a href="${a.url}" target="_blank">${a.title}</a></h4>
                <p>${a.description ? a.description.slice(0, 80) + "..." : "No summary available."}</p>
              </div>
            </div>
          `;
        });
      });
    }
  </script>
</body>
</html>
